--Get monthly average and closing rates.
 
DECLARE @CurrencyID varchar(10) = 'MXP',
@StartPeriod int = 201401


--Get monthly average rates.
SELECT
CURNCYID
,YEAR(EXCHDATE)*100+MONTH(EXCHDATE) as Period
,AVG(XCHGRATE) as Rate
,'AVG' as RateType
FROM MC00100 
WHERE CURNCYID in (@CurrencyID)
AND YEAR(EXCHDATE)*100 + MONTH(EXCHDATE) >= @StartPeriod  AND YEAR(EXCHDATE)*100 + MONTH(EXCHDATE) < YEAR(GETDATE())*100 + MONTH(GETDATE())
GROUP BY YEAR(EXCHDATE)*100+MONTH(EXCHDATE),CURNCYID 
UNION ALL
--Get monthly closing rates.
SELECT
CURNCYID
,Period
,XCHGRATE as Rate
,'CLS' as RateType
FROM
(
SELECT
CURNCYID
,YEAR(EXCHDATE)*100+MONTH(EXCHDATE) as Period
,ROW_NUMBER() OVER(PARTITION BY (YEAR(EXCHDATE)*100+MONTH(EXCHDATE)) ORDER BY EXCHDATE DESC) as Orders
,XCHGRATE
FROM MC00100 
WHERE CURNCYID in (@CurrencyID)
AND YEAR(EXCHDATE)*100 + MONTH(EXCHDATE) >= @StartPeriod AND YEAR(EXCHDATE)*100 + MONTH(EXCHDATE) < YEAR(GETDATE())*100 + MONTH(GETDATE())
) a
WHERE a.Orders = 1
